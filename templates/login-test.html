{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlueVoyage Login</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;400;600;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Poppins', sans-serif, 'Roboto';
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: url("{% static 'images/idk.jpg' %}") no-repeat center center;
            background-size: cover;
        }
        
        .signup-button { 
            position: fixed; top: 20px; right: 20px; 
            background-color: #00b8ff; color: black; 
            padding: 10px 15px; border: none; border-radius: 3px;
            font-weight: 600; font-size: 14px; cursor: pointer;
        }

        .wrapper {
            width: 450px;
            background-color: transparent;
            color: #fff;
            border-radius: 15px;
            padding: 50px 40px;
        }

        .wrapper h1 { font-size: 65px; color: #fff; text-align: center; padding-bottom: 30px; }
        
        .input-box input {
            width: 100%; height: 45px; border: 2px solid #fff; 
            padding: 10px; border-radius: 10px; font-size: 16px; color: #000;
            margin-top: 15px;
        }

        .login-button, .google-signin-button {
            width: 100%; height: 45px; border-radius: 5px; font-weight: 700;
            font-size: 16px; cursor: pointer; margin-top: 15px;
        }
        .login-button { background: #1C342F; color: #fff; }
        .google-signin-button { background: #fff; color: #404040; }
        
        .register-link p, .terms-privacy { text-align: center; margin-top: 10px; }
        .or-container { display: flex; align-items: center; justify-content: center; margin: 20px 0; }
        
        .or-container .line { flex: 1; height: 1px; background-color: #fff; }
        .or-container .or { padding: 0 10px; color: #fff; }
        
        #otp-section { display: none; }
        #error-message { color: red; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>
    <button class="signup-button">Sign up</button>

    <div class="wrapper">
        <form id="login-form">
            <h1>BlueVoyage</h1>

            <div class="input-box">
                <input type="text" id="username" placeholder="Username" required>
            </div>

            <div class="input-box">
                <input type="password" id="password" placeholder="Password" required>
            </div>

            <div class="terms-privacy">
                <p>By logging in, you agree to BlueVoyage's Terms of Service and Privacy Policy.</p>
            </div>

            <button class="login-button" type="submit">Log in</button>

            <div id="otp-section">
                <h2>Enter OTP</h2>
                <div class="input-box">
                    <input type="text" id="otp" placeholder="Enter OTP" required>
                </div>
                <button id="verify-otp" class="login-button">Verify OTP</button>
            </div>

            <div id="error-message"></div>
        </form>
    </div>

    <script>
        const loginForm = document.getElementById('login-form');
        const otpSection = document.getElementById('otp-section');
        const errorMessage = document.getElementById('error-message');
        const verifyOtpButton = document.getElementById('verify-otp');
        let username;
        let superuser = false;

        loginForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Login failed');

                const data = await response.json();
                if ('jwt' in data) {
                    superuser = true;
                    window.location.href = '/test';
                } else {
                    loginForm.style.display = 'none';
                    otpSection.style.display = 'block';
                    errorMessage.innerText = '';
                }
            } catch (error) {
                errorMessage.innerText = error.message;
            }
        });

        if (!superuser) {
            verifyOtpButton.addEventListener('click', async function() {
                const otp = document.getElementById('otp').value;

                try {
                    const response = await fetch('/api/verify-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, otp }),
                        credentials: 'include'
                    });

                    if (!response.ok) throw new Error('OTP verification failed');

                    window.location.href = '/test';
                } catch (error) {
                    errorMessage.innerText = error.message;
                }
            });
        }
    </script>
</body>
</html>
